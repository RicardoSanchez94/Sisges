@model List<SistemaGestion.Models.fnDashboard_Detalle_Temp_Result>
<div class="container shadow-lg p-3 mb-5 mt-5 bg-body rounded">
    <div class="row">
        <div class="col-lg-12">
            <table id="tbDif" class="table table-bordered  display nowrap" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Centro</th>
                        <th>Fecha</th>
                        <th>Tipo_doc</th>
                        <th>Totven</th>
                        <th>Totliv</th>
                        <th>Diferencia</th>
                        <th>Reprocesar</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                    <tr>
                        <td>@item.Centro</td>
                        <td>@item.Fecha</td>
                        <td>@item.Tipo_Documento</td>
                        <td>@item.Total_Tienda.Value.ToString("C")</td>
                        <td>@item.Total_SAP.Value.ToString("C")</td>

                       
                    





                        @{
                            //int dif = Convert.ToInt32(item.diff);
                            int dif = Convert.ToInt32(item.Diferencia);

                            if (dif < 0)
                            {
                                <td class="bg-danger text-white">$@dif.ToString("0,000")</td>
                            }
                            else if (dif > 0)
                            {
                                <td class="bg-warning text-white">$@dif.ToString("0,000")</td>
                            }
                            else
                            {
                                <td class="bg-success text-white">$@dif.ToString("0,000")</td>
                            }
                        }
                    <td class="text-center">
                        @if (item.Tipo_Documento != "BOLETA")
                        {
                            <button type='button' class='editar btn btn-outline-danger btn-sm shadow-sm' title="Reprocesar"
                                    onclick='ReprocesoNCFC("@item.Fecha","@item.Centro", "@item.Tipo_Documento")'>
                                <span class='fa fa-refresh'></span>
                            </button>
                        }
                        else
                        {
                            <button type='button' class='editar btn btn-outline-danger btn-sm shadow-sm' title="Reprocesar"
                                    onclick='Reproceso("@item.Fecha","@item.Centro", "@item.Tipo_Documento")'>
                                <span class='fa fa-refresh'></span>
                            </button>
                        }
                        <button type='button' class='editar btn btn-outline-success btn-sm shadow-sm' title="Dashboard"
                                onclick='Volver("@item.Fecha")'>
                            <span class='fa fa-refresh'></span>
                        </button>

                    </td>

                    </tr>
                    }
                </tbody>

            </table>
            <div class="footer">
                <div class="chart-legend">
                    <div class="text-center">
                        <i class="fa fa-circle text-danger"></i>
                        Tienda con Faltante
                        <i class="fa fa-circle text-success"></i>
                        Tienda Cuadrada
                        <i class="fa fa-circle text-warning"></i>
                        Tienda Con Sobrante o Libro Venta no Cargado

                    </div>

                </div>

            </div>
          
           
        </div>
    </div>
</div>
<div class="modal fade" id="ReprocesoIdocNCFC" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
</div>


<script>
    $(document).ready(function () {
        var tabla;
        tabla = $('#tbDif').DataTable({
            responsive: true,
            "language": {
                url: "@Url.Content("~/Content/datatable/js/datatable_spanish.json")"
            }
        });



    });




     function ReprocesoNCFC(Fecha, Local, Documento) {
        console.log('entro al reproceso');
         var url = "@Url.Action("ReprocesoNCFC", "Gestion")";
        event.preventDefault();
       
            $('#cargal').modal('show');
            $.ajax({
                type: 'POST',
                url: url,
                data: { Fecha: Fecha, Local: Local, Documento: Documento },
                success: function (response) {
                    $("#ReprocesoIdocNCFC").html(response);
                    $("#ReprocesoIdocNCFC").modal('show');
                    setTimeout(function () {
                        $('#cargal').modal('hide');
                    }, 1000);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }

            });
        
    };

    function Reproceso(Fecha, Local, Documento) {
        console.log('entro al reproceso');

             var url = "@Url.Action("GeneraIdocXDoC", "Gestion")";
        event.preventDefault();
        var result = confirm("Desea Generar Idoc?.. Este proceso puede durar mas de 5min");
        if (result) {
            $('#cargal').modal('show');
            $.ajax({
                type: 'POST',
                url: url,
                data: { Fecha: Fecha, Local: Local, Documento: Documento },

                success: function (response) {
                    if (response.error == true) {

                        setTimeout(MostrarMensaje, 5000);
                        setTimeout(bajar, 4000);


                    }
                    else {
                        setTimeout(MostrarMensaje, 5000);
                        setTimeout(bajar, 4000);

                    }
                    function MostrarMensaje() {
                        $('#cargal').modal('hide');
                        $('#cargarMensajes').modal('show');
                        $('#mensajeLoad').html(response.respuesta);
                    };


                    function bajar() {

                        $('#cargarMensajes').modal('hide');
                    };


                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }
            });
        }
    };


    function Volver(Fecha) {
        console.log('entro al Diferencias');
        $('#cargal').modal('show');
         var url = "@Url.Action("Listar", "Home")";
           $.ajax({
            type: 'POST',
               url: url,
               data: { Fecha: Fecha },
               success: function (data) {
                 /*  setTimeout(bajardiv, 1000);*/
                   setTimeout(bajar, 2000);
                   setTimeout(Subir, 2000);


                   function bajar() {
                       $('#cargal').modal('hide');

                   }
                   function Subir() {
                       $('#diferencias').html(data);
                       $('#diferencias').show();
                   }


               },
               error: function (xhr, ajaxOptions, thrownError) {
                   alert(thrownError);
               }
             });
    };

    
</script>

