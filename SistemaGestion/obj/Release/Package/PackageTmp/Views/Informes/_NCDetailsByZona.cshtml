
@model List<SistemaGestion.Models.ViewModels.NcDetailsModel>
<div class="card">
    <div class="card-header text-dark bg-white border border-grey border-bottom-0 pt-0 pb-0">
        <div class="row ml-0 mr-0">
            <div class="col-lg-7 col-md-12 col-sm-12 text-left ml-0 mt-0 pl-0 pt-2 mb-2">
                <h6 class="mb-0 mt-1 1h-100"><i class="fa fa-list"></i> Detalle Busqueda - NOTAS DE CREDITO NORMAL: @(Model.Select(x => x.cantidadNCNormal).Sum()) - ESPECIAL: @(Model.Select(x => x.cantidadNCEspecial).Sum())</h6>
     
            </div>
            <div class="col-lg-5 col-md-12 col-sm-12 text-left ml-0 mt-2 pl-0 pr-0 text-right">
                @if (ViewBag.Back == true)
                {
                    <button class="btn btn-outline-danger mb-2 btn-sm" onclick="volver()"><i class="fa fa-arrow-left"></i> Volver</button>
                }
                <button class="btn btn-outline-success mb-2 btn-sm" onclick="GenerarInformeDetalle(@(ViewBag.isZonaReporte==true ? Model.FirstOrDefault().idZona: 0))"><i class="fa fa-file-excel"></i> Generar Informe</button>
            </div>
        </div>
    </div>
    <div class="card-body border border-grey">
        <div class="mb-2 mt-1">
            <div class="row">

                <div class="col-lg-12">
                    <div class="table-responsive">
                        <table id="tbNCInforme" class="table table-bordered table-hover" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th class="text-center">Fecha</th>
                                    <th class="text-center">Tienda</th>
                                    <th class="text-center">Zona</th>
                                    <th class="text-center">NC Normal</th>
                                    <th class="text-center">NC Especial</th>
                                    <th class="text-center">#</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in Model)
                                {
                                    <tr>
                                        <td class="text-center">@a.fechaNC.ToString("dd-MM-yyyy")</td>
                                        <td class="text-center">@a.nomCencos</td>
                                        <td class="text-center">@a.nomZona</td>
                                        <td class="text-center">@a.cantidadNCNormal</td>
                                        <td class="text-center">@a.cantidadNCEspecial</td>

                                        <td class="text-center">
                                            <button type='button' class='editar btn btn-outline-info btn-sm shadow-sm' title="Detalle"
                                                    onclick="DetalleByCenco('@a.fechaNC', @a.idCencos, @a.idZona, '@a.nomCencos')">
                                                <span class='fa fa-list-alt'></span>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ModalDetalle" role="dialog">
</div>
<script>

    function DetalleByCenco(fecha, cencos, zona,nomCencos) {

        var data = { fecha: fecha, idCencos: cencos, idZona: zona, nomCenco: nomCencos};
         var url = "@Url.Action("detailsNCByCenco", "Informes")";
        $.ajax({
            type: 'POST',
            url: url,
            data: data,
            success: function (response) {
                $("#ModalDetalle").html(response);
                $("#ModalDetalle").modal('show');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
    }

    function volver() {
        $("#detalleNC").show();
        $("#detalleNCListaByZona").html("");
    }

    function GenerarInformeDetalle(idZona) {
        var Inicio = $("#Inicio").val();
        var Fin = $("#Fin").val();
        var data = { Inicio: Inicio, Fin: Fin, idZona: idZona };
        var url = "@Url.Action("GetReporteNCDetails", "Informes")";

      
        var list = [];
        var fileName = '';
        list.push({ fileName: fileName });

        $('#cargal').modal('show');
        $.ajax({
            url: url,
            type: "post",
            data: data,
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data, textStatus, xhr) {
                var filename = list[0].filename;
                var disposition = xhr.getResponseHeader('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    var matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                    var a = document.createElement('a');
                    var url = window.URL.createObjectURL(data);
                    a.href = url;
                    a.download = filename;
                    document.body.append(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                }
                else {
                    alert("ERROR AL DESCARGAR ARCHIVO");
                    $("#cargal").modal('hide');
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {

            },
            complete: function () {
                setTimeout(function () {
                    $("#cargal").modal('hide');
                }, 1500);

            }
        });




    }

      $(document).ready(function () {

        var tabla_data;
          tabla_data = $('#tbNCInforme').DataTable({
             "language": {
                   url: "@Url.Content("~/Content/datatable/js/datatable_spanish.json")"
               }
        });
    });

</script>

