@model List<SistemaGestion.Models.ViewModels.UserProfileView>
@{
    ViewBag.Title = "ADMINISTRACIÓN DE USUARIOS";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row">
    <div class="col-12">
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-item nav-link mr-1 active" id="nav-users-tab" data-toggle="tab" href="#nav-users" role="tab" aria-controls="nav-users" aria-selected="true">Administración Usuarios</a>
                <a class="nav-item nav-link" id="nav-zona-tab" data-toggle="tab" href="#nav-zona" role="tab" aria-controls="nav-zona" aria-selected="false">Asignación Zonas</a>
                <a class="nav-item nav-link" id="nav-cenco-tab" data-toggle="tab" href="#nav-cenco" role="tab" aria-controls="nav-cenco" aria-selected="false">Administración Tiendas</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            @*ADMINISTRACION DE USUARIOS*@
            <div class="tab-pane fade  show active" id="nav-users" role="tabpanel" aria-labelledby="nav-users-tab">
                <div class="card mt-2 shadow-sm">
                    <div class="card-header bg-secondary text-left">
                        <div class="form-row">
                            <div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
                                <h5 class="text-white"><i class="fa fa-users fa-fw"> </i> PANEL DE ADMINISTRACIÓN DE USUARIOS</h5>
                            </div>
                            <div class="col-lg-3 col-md-3 col-sm-3 col-xs-12 text-right bg-secondary">
                                <div class="btn btn-danger" id="addUsuario">
                                    AGREGAR USUARIO
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="table-responsive">
                                <table width="100%" id="idTablaUsuarios" class="table table-striped table-bordered" cellspacing="0">
                                    <thead class="colorRojo">
                                        <tr>
                                            <th class="text-center">USUARIO</th>
                                            <th class="text-center">NOMBRES</th>
                                            <th class="text-center">APELLIDO PATERNO</th>
                                            <th class="text-center">APELLIDO MATERNO</th>
                                            <th class="text-center">#</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @*ADMINISTRACION DE zonals a zonales*@
            <div class="tab-pane fade" id="nav-zona" role="tabpanel" aria-labelledby="nav-zona-tab">


            </div>
            @*ADMINISTRACION DE tiendas*@
            <div class="tab-pane fade" id="nav-cenco" role="tabpanel" aria-labelledby="nav-cenco-tab">


            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="roles" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4>Lista de Roles</h4>
            </div>
            <div class="modal-body">
                <div id="content" class="text-center">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mensajeResetpass" role="dialog">
    <div class="modal-dialog modalCustom modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="contentResetpass" class="text-center">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="myModal" role="dialog">
    <div id="cont">
    </div>
</div>

@section scripts{
    <script type="text/javascript">
    $(document).ready(function () {


        $('#nav-zona-tab').click(function () {
            var url = '@Url.Action("adminZonas", "AdminUser")';
            $.ajax({
                type: 'GET',
                url: url,
                async: false,
                success: function (response) {
                    $("#nav-zona").html(response);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }
            });

        });


        //---------------------------------------------------------------------------

        $('#addUsuario').click(function () {
            var url = '@Url.Action("CreateUsuario", "Account")';
            $.ajax({
                type: 'GET',
                url: url,
                async: false,
                success: function (response) {
                    $("#myModal").html(response);
                    $("#myModal").modal('show');
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }
            });
        });

        //*******************************************************************************
        //*******************************************************************************
        var table = $("#idTablaUsuarios").DataTable({
            "responsive": true,
            "lengthMenu": [[5, 10, 15, 25, 50, 100], [5, 10, 15, 25, 50, 100]],// filtro cantidad de registros
            "searching": true,// busqueda
            "processing": true, // muestra la barra de progreso
            "serverSide": true, // proceso lado del server
            "filter": true, // search box
            //"orderMulti": false,
            "ajax": {
                "url": '@Url.Action("ListaUsuarios", "AdminUser")',
                "type": "POST",
                "datatype": "json"
            },
            "columns": [
                        { "data": "LoginName", "name": "LoginName", "autoWidth": true },
                        { "data": "nombres", "name": "nombres", "autoWidth": true },
                        { "data": "ApellidoPaterno", "name": "ApellidoPaterno", "autoWidth": true },
                        { "data": "ApellidoMaterno", "name": "ApellidoMaterno", "autoWidth": true },
                        {
                            "targets": -1,
                            "data": null,
                            "className": "text-center",
                            "defaultContent": "<a id='Lroles' class='btn btn-outline btn-danger btn-sm text-white'  data-placement='right' data-toggle='tooltip' data-original-title='Ver Roles' title='Ver Roles'><span class='fa fa-list'></span></a> <a id='Cpass' class='btn btn-outline btn-danger btn-sm text-white'  data-placement='right' data-toggle='tooltip' data-original-title='Resetar Contraseña' title='Resetar Contraseña'><span class='fa fa-lock'></span></a> <a id='editar' class='btn btn-outline btn-danger btn-sm text-white'  data-placement='right' data-toggle='tooltip' data-original-title='Editar Usuario' title='Editar Usuario'><span class='fa fa-edit'></span></a> "

                        }
            ],
            "language": {
                "sProcessing": "BUSCANDO...",
                "sLengthMenu": "MOSTRAR _MENU_ REGISTROS",
                "sZeroRecords": "NO SE ENCONTRARON RESULTADOS",
                "sEmptyTable": "NINGÚN DATO DISPONIBLE EN ESTA TABLA",
                "sInfo": "MOSTRANDO REGISTROS DEL _START_ AL _END_ DE _TOTAL_ ",
                "sInfoEmpty": "MOSTRANDO DEL 0 AL 0 DE UN TOTAL DE 0 REGISTROS",
                "sInfoFiltered": "(FILTRADO DE UN TOTAL DE _MAX_ REGISTROS)",
                "sInfoPostFix": "",
                "sSearch": "BUSCAR(USUARIO, NOMBRE, EMAIL):",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "CARGANDO...",
                "oPaginate": {
                    "sFirst": "PRIMERO",
                    "sLast": "ÚLTIMO",
                    "sNext": "SIGUIENTE",
                    "sPrevious": "ANTERIOR"
                }
            }
        });

        //*******************************************************************************
        //*******************************************************************************
        //carga los tooltips
        $('a').tooltip();

        //*******************************************************************************
        //*******************************************************************************
        //function VerRoles() {

        $('#idTablaUsuarios tbody').on('click', 'a', function () {
            var id = $(this).attr("id");
            var data = table.row($(this).parents('tr')).data();
            var Name = data["LoginName"];
            var idUsuario = data["idUsuario"];

            if (id == "Lroles") {
                rolesusuario(Name);
            }
            if (id == "Cpass") {

                cambioPass(Name);
            }
            if (id == "editar") {
                editaUsuario(idUsuario);

            }
        });
    });//FIN DOCUMENTO


    // EDITAR USUARIO
    function editaUsuario(idUsuario) {

        var url = '@Url.Action("CreateUsuario", "Account")';
        $.ajax({
            type: 'POST',
            url: url,
            data: { idUsuario: idUsuario },
            success: function (response) {
                $("#myModal").html(response);
                $("#myModal").modal('show');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
    };

    //LISTA ROLES DE USUARIO
    function rolesusuario(LogName) {

        var url = '@Url.Content("~/Account/ListaRolesUsuarioModal")';
        $.ajax({
            type: 'POST',
            url: url,
            data: { LogName: LogName },
            success: function (response) {

                $("#content").html(response);
                $("#roles").modal('show');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
        //return false;
    };
    //CAMBIA CONTRASEÑA USUARIO
    function cambioPass(LogName) {


        $("#contenidoModalConfirmacion").html('¿ESTA SEGURO DE RESETAR CONTRASEÑA?');
        $("#confirmaModal").modal({ backdrop: 'static', keyboard: false });
        $("#confirmaModal").modal('show').one('click', '#guardar', function (e) {


            var obj = window.btoa(LogName);
            var url = '@Url.Content("~/Account/changePassAdmin")';
            $.ajax({
                type: 'GET',
                url: url,
                data: { obj: obj },
                success: function (r) {
                    if (r.error) {
                        $("#contentResetpass").html(r.respuesta);
                        $("#mensajeResetpass").modal('show');
                    } else {
                        $("#contentResetpass").html(r.respuesta);
                        $("#mensajeResetpass").modal('show');
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }
            });
        });
    };
    </script>
}